# Лабораторная работа 3

## 1. Для чего предназначен системный реестр Windows?

Microsoft Windows XP Professional хранит параметры аппаратуры и программного обеспечения в иерархической базе данных
– реестре (registry). Реестр заменяет множество файлов конфигурации .ini, .sys и .com, применявшихся в ранних версиях
Microsoft Windows. Реестр управляет операционной системой Windows XP, предоставляя информацию, которая требуется при
загрузке и инициализации Windows XP, при запуске приложений и при загрузке системных компонентов, таких как драйверы
устройств и сетевые протоколы.

## 2. Приведите примеры использования реестра компонентами Windows XP.

Так, в процессе загрузки ядро Windows XP (NTOSKRNL.EXE) считывает информацию из реестра о загружаемых устройствах и
порядке их загрузки. В свою очередь, ядро записывает в реестр собственную динамически формируемую информацию, например,
параметры процессоров, номер версии системы. Драйверы устройств получают параметры настройки из реестра. Они
также записывают в реестр информацию об изменении опций и режимов. Драйверы устройств помещают в реестр данные о том,
какие ресурсы системы используются, например, каналы прямого доступа к памяти (DMA).

## 5. Охарактеризуйте структуру реестра.

Определяющими для формирования структуры реестра являются такие понятия, как раздел (или ключ), параметр, тип параметра,
ссылка, предопределенный ключ, ветвь, куст.

| Понятие | Описание |
|-|-|
| Раздел (синоним – ключ) Подраздел (синоним – подключ) | Раздел – это узел в иерархической структуре реестра (аналог папки в файловой системе). Разделы соответствуют программным или аппаратным объектам, либо их группам. Подразделы – это разделы внутри разделов более высокого уровня |
| Параметр | Параметр – это лист в дереве реестра. Каждый раздел содержит один или несколько параметров. С параметром связано три элемента: имя, тип данных и значение. Параметр, имеющий имя «По умолчанию» (default), является обязательным (всегда присутствует в ключе) |
| Тип данных | Каждое значение в реестре относится к одному из следующих типов данных: <br/> **REG_SZ** – строковое значение. Windows ХР интерпретирует его как строку, заканчивающуюся нулевым байтом; <br/> **REG_BINARY** – двоичное значение, представляет собой последовательность байт, задаваемых строкой шестнадцатеричных цифр. Windows ХР интерпретирует каждую пару цифр как значение байта; <br/> **REG_DWORD** – 32-разрядное значение, задается последовательностью от 1 до 8 шестнадцатеричных цифр; <br/> **REG_MULTI_SZ** – многострочное значение. Представляет собой массив значений типа «строка символов». Каждая строка заканчивается нулевым байтом; <br/> **REG_EXPAJND_SZ** – расширяемое строковое значение. Подобно типу REG_SZ, но текст может содержать подставляемые переменные. Например, в строке %systemroot%\Config, Windows XP заменит имя переменной среды systemroot на путь к папке Windows\System32; <br/> **REG_FULL_RESOURCE_DESCRIPTOR** – список ресурсов. Хранит список ресурсов для аппаратного компонента или драйвера. Значения этого типа запрещено добавлять или модифицировать |
| Предопределенный ключ | Предопределенный ключ – подраздел корневого узла «Мой компьютер» дерева реестра. Реестр Windows XP фактически содержит два поддерева: HKEY_LOCAL MACHINE и HKEY_USERS. Однако чтобы сделать информацию реестра более доступной для просмотра и поиска, корневой раздел содержит пять подразделов: <br/> 1) HKEY_LOCAL_MACHINE <br/> 2) HKEY_CLASSES_ROOT <br/> 3) HKEY_CURRENT_CONFIG <br/> 4) HKEY_USERS <br/> 5) HKEY_CURRENT_USER <br/> Три из них являются ссылками на внутренние узлы деревьев: <br/> HKEY_LOCAL_MACHINE и HKEY_USERS. Это подразделы HKEY_CLASSES_ROOT, HKEY_CURRENT_CONFIG и HKEY_CURRENT_USER |
| Куст | Куст представляет собой набор разделов, подразделов и параметров, имеющих один общий корень. Данные каждого куста сохраняются в соответствующем ему файле. Файлы кустов системного реестра ключа HKEY_LOCAL_MACHINE располагаются в %systemroot%\System32\Config. Кроме того, Windows ХР записывает вносимые в куст изменения в файл с именем куста и расширением log, что гарантирует целостность системного реестра. <br/> Данные ключа HKEY_USERS хранятся в папке Documents and Settings |

## 6. Перечислите основные файлы реестра

Рассмотрим назначение основных ветвей реестра:
1. **HKEY_LOCAL_MACHINE** – это корневой узел ветви, которая содержит в своих подразделах все параметры настройки
локального компьютера, в том числе данные об оборудовании и операционной системе, такие как тип шины, объем памяти, 
список драйверов устройств и данные, управляющие процессом их загрузки. Приложения, драйверы устройств и операционная 
система используют эти данные для определения конфигурации компьютера. Данные в этой ветви являются общими для системы 
и не зависят от пользователя. Второй
уровень этой ветви представлен пятью подразделами:

    1) **HARDWARE** – содержит данные о типе и состоянии физических
    устройств, подключенных к компьютеру. Подраздел формируется динамически из информации, получаемой в процессе загрузки 
    системы. Значения подраздела не отображаются в файл на диске. Приложения обращаются к этому подразделу, чтобы определить
    тип и состояние устройств, подключенных к компьютеру;
    2) **SAM** – представляет собой куст с данными системы разграничения доступа для компьютера. Куст SAM отображается в
    файлы SAM и SAM.LOG в каталоге %systemroot%\System32\Config. Приложения, обращающиеся к подразделу SAM, должны
    использовать соответствующий интерфейс прикладного программирования (API);
    3) **SECURITY** – узел, который начинает ветвь с информацией системы безопасности локального компьютера. Информация
    этого куста сохраняется в файлах Security и Security.log, расположенных в каталоге %systemroot%\System32\Config.
    Приложения не могут модифицировать подразделы этой ветви. Однако они могут запрашивать информацию о безопасности,
    используя соответствующие системные вызовы прикладного интерфейса;
    4) **SOFTWARE** – ключ, начинающий ветвь с информацией о программном обеспечении, установленном на локальном компьютере. Это
    общая для системы информация, не зависящая от того, какой пользователь работает в данный момент. Здесь содержится информация о привязке типов файлов, а также информация OLE и COM. Куст отображается в
    файлы Software и Software.log, расположенные в каталоге
    %systemroot%\System32\Config;
    5) **SYSTEM** – начало ветви с информацией о системных устройствах и службах. Когда вы устанавливаете или настраиваете драйвер
    устройства или службу, добавляется или модифицируется информация в
    этом кусте. Куст SYSTEM отображается в файлы System и
    System.log в каталоге %systemroot%\System32\Config. Реестр
    хранит резервную копию куста SYSTEM в файле System.alt.

Ключи **HKEY_CLASSES_ROOT** и **HKEY_CURRENT_CONFIG** являются ссылками на два внутренних узла ветви HKEY_LOCAL_MACHINE.

2. **HKEY_USERS** – это раздел, который объединяет информацию, специфичную для каждого пользователя. В этом разделе
расположены пять подразделов:

    1) **.DEFAULT.** Подраздел содержит идентификатор системы безопасности (SID) для текущего пользователя и устанавливаемые по
    умолчанию параметры системы (системный профиль по умолчанию), используемые при отображении вызываемого нажатием клавиш
    Ctrl+Alt+Delete окна регистрации;
    2) **HKEY_CURRENT_USER**. Данная ветвь является ссылкой на дочерний раздел ключа HKEY_USERS, содержащий данные о текущем
    пользователе. Поддерево, как показано на рисунке 3, указывает на те же данные, что и содержащиеся в разделе
    HKEY_USERS\SID. Система получает для этой ветви из файла Ntuser.dat копию данных учетной записи текущего пользователя.
    Файл Ntuser.Dat находится в папке %systemroot%\Profiles\имя_пользователя. Находящиеся в этом подразделе значения имеют
    более высокий приоритет, чем аналогичные значения в поддереве HKEY_LOCAL_MACHINE.
    
## 7. 8. Перечислите и охарактеризуйте способы создания резервных копий реестра. Перечислите и охарактеризуйте способы восстановления реестра из резервных копий.
Рассмотрим возможные пути создания архивных копий и восстановления системных файлов:

1) **использование функции «Восстановление системы»**, встроенной в Windows ХР;
2) **архивирование необходимых файлов**. Этот подход является более надежным и позволяет восстанавливать не только реестр,
но и систему в целом. Встроенным в систему способом архивации данных является использование системной программы
архивации ntbackup.exe, находящейся в папке %SystemRoot%\system32\. Запуск производится выбором команды в меню
Пуск –&gt; Все программы –&gt; Стандартные –&gt; Служебные –&gt; Архивация Данных. При запуске появится окно, где
необходимо выбрать пункт **«МАСТЕР АРХИВАЦИИ»**. Запустившись, мастер предложит выбрать, что необходимо архивировать –
все данные, данные выбранных файлов, либо данные состояния системы. Необходимо выбрать последний пункт, при этом в
архиве будут сохранены: реестр; база данных регистрации классов COM; загрузочные системные файлы; защищенные системные
файлы Windows. Далее необходимо указать расположение будущего архива и его название. Заметим, что для выполнения
архивации необходимо обладать полномочиями администратора или оператора архива. В режиме консоли для архивации
используется команда **ntbackup backup systemstate**;
3) **создание резервной копии реестра простым копированием файлов**, находящихся в папке %systemroot%\system32\config,
в другое место. При этом необходимо копировать файлы: Appevent.evt, Default, Default.Log, Default.Sav, SAM, SAM.log,
Secevent.evt, Security, Security.Log, Software, Software.log, Software.Sav, Sysevent.Evt, System, System.Log,
System.sav, Userdiff, Userdiff.log. Для восстановления нужно будет просто скопировать эти файлы обратно в папку config.
Однако если файловой системой на системном диске является NTFS, то восстановление будет возможно либо из другой копии
Windows XP, установленной на этом же компьютере, либо из консоли восстановления. В случае файловой системы FAT
копирование файлов из архива можно произвести, загрузившись под MS DOS;
4) **импорт и экспорт реестра с применением Редактора реестра**. Редактор реестра (программа Regedit.exe или
Regedt32.exe) позволяет экспортировать весь реестр целиком либо отдельные его ключи. Для экспорта всего реестра
необходимо выделить корневой узел (значок «Мой компьютер») и выполнить команду «Экспорт» в меню «Файл». Для экспорта
части реестра делаем то же, только выбираем конкретный ключ. В результате будет получен файл экспорта реестра с
расширением **REG**. Содержимое этого файла представляет структурированный определенным образом текст в формате ASCII,
который можно читать и редактировать при помощи обычного текстового редактора. Обратный процесс внесения данных в
реестр выполняется посредством процедуры импорта reg-файла. Для этого достаточно сделать двойной щелчок по файлу
с расширением **REG** либо выполнить команду **«Импорт»** в меню **«Файл»** программы Редактора реестра.

# 11. Охарактеризуйте структуру файла экспорта реестра.

Файл экспорта реестра (reg-файл) имеет жестко регламентированную структуру данных. В начале любого такого файла должна
находиться строка **Windows Registry Editor Version 5.00** (или **REGEDIT 4** для Windows 95\98). Без этой строки файл не
воспринимается Редактором реестра как «свой» при выполнении процедуры импорта (внесения данных в реестр).

После строки **Windows Registry Editor Version 5.00** должна присутствовать пустая строка, за которой располагаются строки
ключей и параметров, вносимые в реестр. Для каждого имени раздела должна быть выделена отдельная строка. Полное имя
раздела (сокращения не допускаются) помещается в квадратные скобки. Параметры добавляемого раздела записываются
по одному в строке сразу после строки с именем раздела. Описание параметра включает имя параметра, указываемое в
кавычках. Сразу за именем параметра записывается символ «=», за которым следует значение параметра. Значение
строкового параметра должно приводиться в кавычках, значение параметра типа DWORD – в виде шестнадцатеричной строки
вида **dword:XXXXXXXX** без кавычек, значение двоичного параметра – в шестнадцатеричной системе в виде строки
**hex:XX,XX,XX,XX**. Здесь **X** – это любая шестнадцатеричная цифра. Если в значении строкового параметра встречается
символ «\», то он заменяется в файле экспорта реестра на два таких символа («\\»). Одиночный символ «\» используется
для обозначения переноса длинных строк. Имя каждого раздела или подраздела, вносимого в реестр, должно полностью
записываться в отдельной строке. Между описаниями каждого из разделов и в конце файла должно находиться по одной
пустой строке. Символ «@» соответствует имени параметра «По умолчанию». Запись такого параметра имеет вид 
**@=[значение параметра]**. Для просмотра файла экспорта необходимо после щелчка правой кнопкой выбрать в контекстном
меню пункт «Изменить».
